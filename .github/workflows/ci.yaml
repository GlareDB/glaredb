name: GlareDB CI

on: [push, workflow_dispatch]

jobs:
  pre_test:
    continue-on-error: true
    runs-on: ubuntu-latest
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}

    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v4
        with:
          concurrent_skipping: 'same_content_newer'
          skip_after_successful_duplicate: 'true'
          paths_ignore: '["**/README.md", "**/docs/**"]'
          cancel_others: 'true'


  test:
    needs: pre_test
    if: ${{ needs.pre_test.outputs.should_skip != 'true' }}
    name: CI
    runs-on: ubuntu-latest-8-cores
    concurrency:
      group: ci-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install nix
        uses: cachix/install-nix-action@v18
        with:
          extra_nix_config: |
            access-tokens = github=${{ github.token }}

      - name: configure cachix
        uses: cachix/cachix-action@v12
        with:
          name: glaredb-ci
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: run checks
        run: nix flake check -L

      - name: SQL Logic Tests
        # Use globstar to ensure that all subdirectories are expanded.
        run: |
          shopt -s globstar
          nix run .#slt-runner -- -v embedded testdata/sqllogictests/**/*.slt

      - name: Protocol Tests
        run: ./scripts/protocol-test.sh
