apiVersion: apps/v1
kind: Deployment

metadata:
  name: glaredb-proxy
  labels:
    app: glaredb-proxy

spec:
  replicas: 1

  selector:
    matchLabels:
      app: glaredb-proxy

  template:
    metadata:
      labels:
        app: glaredb-proxy
    spec:
      serviceAccountName: glaredb-proxy-service-account
      containers:
        # Note: we use autopilot, so no resource requests/limits are set
        - name: glaredb-proxy
          command: ["glaredb"]
          args: [
              "-v",
              "--json-logging",
              "proxy",
              "--bind",
              "0.0.0.0:6543",
              "https://qa.glaredb.com",
            ]
          # The 'main' tag is continuously deployed from the main branch of the
          # GlareDB/glaredb repository. We have to explicitly set imagePullPolicy
          # to 'Always' because K8s only does this if we use a ':latest' tag.
          image: gcr.io/glaredb-dev-playground/pgsrv:main
          imagePullPolicy: Always
          livenessProbe:
            tcpSocket:
              port: 6543
            initialDelaySeconds: 15
            periodSeconds: 20
          ports:
            - containerPort: 6543
              name: postgres-proxy
              protocol: TCP
---

apiVersion: v1
kind: ServiceAccount
metadata:
  name: glaredb-proxy-service-account
automountServiceAccountToken: true

---
# LoadBalancer for exposing glaredb-proxy on a static/reserved IP
apiVersion: v1
kind: Service
metadata:
  name: glaredb-proxy-service
  annotations:
    kubernetes.io/ingress.class: gce
spec:
  type: LoadBalancer
  selector:
    app: glaredb-proxy
  ports:
    - protocol: TCP
      port: 6543
      targetPort: 6543
  # This is a reserved IP in the us-central1 region. It has a name
  # 'qa-glaredb-proxy-ip'
  loadBalancerIP: 34.132.144.12
